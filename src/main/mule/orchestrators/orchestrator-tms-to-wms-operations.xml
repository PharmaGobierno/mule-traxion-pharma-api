<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="orchestrator-tms-to-wms-operations-appointment-confirmation" doc:id="160f54d0-8e9c-4b2e-8fd0-93515ce93a55" >
		<logger level="INFO" doc:name="Logger" doc:id="934f628c-9e97-49f1-b8e6-2b57c46086cd" message="#[payload]"/>
		<ee:transform doc:name="Transform Message" doc:id="32e1f882-c550-48c5-83fc-c89c13e494c3" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
    "payload":  {
        "whse_id": payload.CTRL_SEG.WHSE_ID,
        "host_client_id": "PISA",
        "transaction_type": payload.CTRL_SEG.CARRIER_MOVE_SEG.Transaction_type,
        "load_id": payload.CTRL_SEG.CARRIER_MOVE_SEG.load_id,
        "stops": payload.CTRL_SEG.*STOP_SEG map (stop) ->
            {
                "segnam": stop.SEGNAM,
                "client_id": stop.CLIENT_ID,
                "stop_number": stop.stop_number,
                "stop_description": stop.stop_description,
                "stop_sequence": stop.stop_sequence,
                "orders": payload.CTRL_SEG.*SHIPMENT_LINE_SEG map (order)->
                    {
                        "segnam": order.SEGNAM,
                        "shipto_id": order.order_number ++ stop.stop_number,
                        "host_client_id": order.CLIENT_ID,
                        "order_number": order.order_number,
                        "items": [
                            {
                                "client_id": order.CLIENT_ID,
                                "ordnum": order.order_number,
                                "product_number": order.item default "ITEMA",
                                "quantity": order.quantity default "5"
                            }
                        ]
                    }
            }
        
    },
    "origin_timestamp" : now() as Number {unit: "milliseconds"},
    "event": "APPOINTMENT_CONFIRMED",  // UPDATE, CANCEL
    "publish_at": now() as Number {unit: "milliseconds"},
    "project": "PISA", //attributo de filtro obligatorio
    "company": "WMS", //attributo de filtro obligatorio
    "version": "1" //attributo de filtro obligatorio
}]]></ee:set-payload>
			</ee:message>
			<ee:variables >
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="3358b28c-00e0-43e5-a752-a860d8aa1578" message="#[payload]" />
		<flow-ref doc:name="client-pub-sub-appointment-confirmation" doc:id="341d8a04-c3fb-4c7a-9737-ad212e7685cd" name="client-pub-sub-appointment-confirmation" />
		<ee:transform doc:name="Transform Message1" doc:id="e4d6c95d-46bd-4a1a-87a8-9c72f3828bcf" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---

{
    "traxion_response": {
        "response": {
            "message": "successful",
            "data": {
              "transactionId": correlationId
            }
        },
        "completedSuccessfully": true
    }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
</mule>
