<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="orchestrator-kafka-pisa-to-oms-create-order" doc:id="0ba960ca-dce9-496f-b370-941aba4c9c05" >
		<logger level="INFO" doc:name="Logger" doc:id="f6faa9ac-ac1f-45f8-a8f8-93104e99bed1" message="#[payload]" />
		<ee:transform doc:name="Transform Message" doc:id="13553660-0293-4b27-a5f4-7c051a02f555">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    "payload":{
        "process_id": correlationId,
        "orders": payload.create_order map(item)->
            {
                "order_number": item.order_number,
                "order_type": item.order_type, 
                "customer_id": item.customer_id, //id del cliente lugar al que se entrega destination e.j ISSSTE
                "address_id": item.address_id, //id de la unidad   e.j Hospital reginal siglo XXI, Venustiano carranza
                "products": item.skus map (sku)->
                    {
                    "sku": item.sku, 
                    "quantity": sku.quantity, 
                    "origin_warehouse": sku.origin_warehouse
                    },
                "institution_number": item.institution_number,
                "issuance_date": item.issuance_date, // Optional[int] (***)emision de pedido ?
                "delivery_date": item.max_delivery_date,  //*** // max_delivery_date
                "appointment_delivery_date": "" // Optional[str]
            }
        
    },
    "origin_timestamp" : now() as Number {unit: "milliseconds"},
    "event": "CREATE",  // UPDATE, CANCEL
    "publish_at": now() as Number {unit: "milliseconds"},
    "project": "PISA", //attributo de filtro obligatorio
    "company": "PISA", //attributo de filtro obligatorio
    "version": "1" //attributo de filtro obligatorio
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<flow-ref doc:name="client-pub-sub-create-order" doc:id="bf18d3d6-4438-4ec1-962f-3823464ea7c6" name="client-pub-sub-create-order" />
		<ee:transform doc:name="Transform Message1" doc:id="9dae25d3-3181-4bf9-ba2c-a7a7f8f8b0e8" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---

{
    "traxion_response": {
        "response": {
            "message": "successful",
            "data": {
              "transactionId": correlationId
            }
        },
        "completedSuccessfully": true
    }
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
</mule>
